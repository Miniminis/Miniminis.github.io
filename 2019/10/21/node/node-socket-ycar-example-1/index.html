<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.9.0">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="flash&#39;s blog">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      Socket.io 이용하여 서로 다른 두 사용자간 실시간 데이터 공유 | Flashlog
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/css/plugins/gitment.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
  
    <script src="/js/gitment.js"></script>
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-149033629-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-149033629-1');
    </script>

</head>
<div class="wechat-share">
  <img src="/css/images/logo.png">
</div>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Flashlog</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags2/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about2/" class="item-link">About</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags2/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about2/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>Socket.io 이용하여 서로 다른 두 사용자간 실시간 데이터 공유</h2>
  <p class="post-date">2019-10-21</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p>지난번 <a href="https://miniminis.github.io/2019/10/11/node-deploy/">firebase와 aws ec2에 node 서버 배포하기</a> 포스팅을 통해 연차 프로젝트를 간단히 소개하며 node 서버의 최종 배포 부분을 다루었다. 연차 프로젝트는 직장인을 위한 카풀 웹앱으로, 탑승자용 어플리케이션과 운전자용 어플리케이션이 나누어져있다. 오늘은 바로 이 두 사용자, 탑승자와 운전자가 실시간으로 데이터를 공유하는 부분을 구성하는 과정에서, socket.io 를 이용하여 node 서버를 구축한 과정을 간단히 포스팅할까한다. <em>클라이언트 쪽 실제 코드는 훨씬 길지만, socket 통신부분의 핵심이 되는 부분만 간략하게 표현하였다.</em><br><br></p>
<h2 id="구현하고자-하는-것-구현-결과-이미지-포함"><a href="#구현하고자-하는-것-구현-결과-이미지-포함" class="headerlink" title="구현하고자 하는 것 (구현 결과 이미지 포함)"></a>구현하고자 하는 것 (구현 결과 이미지 포함)</h2><p>소켓 통신을 이용해 구현하고자 하는 세 부분은 다음과 같았다. </p>
<h4 id="1-카풀-리스트에서-탑승자는-탑승대기-운전자는-운행시작을-누른다-gt-gt-운행-중-화면으로-동시에-전환"><a href="#1-카풀-리스트에서-탑승자는-탑승대기-운전자는-운행시작을-누른다-gt-gt-운행-중-화면으로-동시에-전환" class="headerlink" title="1. 카풀 리스트에서 탑승자는 탑승대기, 운전자는 운행시작을 누른다 &gt;&gt; 운행 중 화면으로 동시에 전환"></a>1. 카풀 리스트에서 탑승자는 탑승대기, 운전자는 운행시작을 누른다 &gt;&gt; 운행 중 화면으로 동시에 전환</h4><p><img src="/images/ycar14.png" alt="운행시작"></p>
<h4 id="2-운행-중-화면에서-탑승자가-운행종료를-누르면-gt-gt-두-사용자의-화면이-동시에-결제페이지로-이동"><a href="#2-운행-중-화면에서-탑승자가-운행종료를-누르면-gt-gt-두-사용자의-화면이-동시에-결제페이지로-이동" class="headerlink" title="2. 운행 중 화면에서 탑승자가 운행종료를 누르면 &gt;&gt; 두 사용자의 화면이 동시에 결제페이지로 이동"></a>2. 운행 중 화면에서 탑승자가 운행종료를 누르면 &gt;&gt; 두 사용자의 화면이 동시에 결제페이지로 이동</h4><p><img src="/images/ycar15.png" alt="운행시작"></p>
<h4 id="3-사용자가-결제에-성공하면-gt-gt-결제-내역-정보를-두-사용자에게-동시에-표시"><a href="#3-사용자가-결제에-성공하면-gt-gt-결제-내역-정보를-두-사용자에게-동시에-표시" class="headerlink" title="3. 사용자가 결제에 성공하면 &gt;&gt; 결제 내역 정보를 두 사용자에게 동시에 표시"></a>3. 사용자가 결제에 성공하면 &gt;&gt; 결제 내역 정보를 두 사용자에게 동시에 표시</h4><p><img src="/images/ycar18.png" alt="운행시작"><br><br><br></p>
<h2 id="왜-node-어째서-socket-io"><a href="#왜-node-어째서-socket-io" class="headerlink" title="왜 node, 어째서 socket.io?"></a>왜 node, 어째서 socket.io?</h2><p>구현하고 싶은 것이 명확해졌고, 이를 구현하기 위해서 어떤 기술을 이용해야할지를 고민해야했다. 실시간 양방향 통신과 관련하여 구글링을 했고, 웹소켓과 socket.io를 찾을 수 있었다. 조원들과 논의한 결과, 우리는 node.js 모듈인 socket.io 를 쓰기로 결정했는데, 그 이유는 다음과 같았다. <br></p>
<h5 id="Html5-표준안의-일부로-나온-Web-Socket-프로토콜의-경우는-지원하는-브라우저가-한정되어있었고-브라우저마다-지원하는-버전에도-차이가-있었다"><a href="#Html5-표준안의-일부로-나온-Web-Socket-프로토콜의-경우는-지원하는-브라우저가-한정되어있었고-브라우저마다-지원하는-버전에도-차이가-있었다" class="headerlink" title="Html5 표준안의 일부로 나온 Web Socket 프로토콜의 경우는 지원하는 브라우저가 한정되어있었고 브라우저마다 지원하는 버전에도 차이가 있었다."></a>Html5 표준안의 일부로 나온 Web Socket 프로토콜의 경우는 지원하는 브라우저가 한정되어있었고 브라우저마다 지원하는 버전에도 차이가 있었다.</h5><h5 id="반면-socket-io-같은-경우는-표준기술이-아니라-node-js-모듈의-일부로서-Web-Socket과-관련-기술들을-하나의-API로-모아놓은-개념이었다-따라서-해당-모듈이-브라우저마다-적합한-socket-기술을-적용해줄-수-있었고-구현하기에도-훨씬-편했다"><a href="#반면-socket-io-같은-경우는-표준기술이-아니라-node-js-모듈의-일부로서-Web-Socket과-관련-기술들을-하나의-API로-모아놓은-개념이었다-따라서-해당-모듈이-브라우저마다-적합한-socket-기술을-적용해줄-수-있었고-구현하기에도-훨씬-편했다" class="headerlink" title="반면 socket.io 같은 경우는 표준기술이 아니라 node.js 모듈의 일부로서 Web Socket과 관련 기술들을 하나의 API로 모아놓은 개념이었다. 따라서 해당 모듈이 브라우저마다 적합한 socket 기술을 적용해줄 수 있었고 구현하기에도 훨씬 편했다."></a>반면 socket.io 같은 경우는 표준기술이 아니라 node.js 모듈의 일부로서 Web Socket과 관련 기술들을 하나의 API로 모아놓은 개념이었다. 따라서 해당 모듈이 브라우저마다 적합한 socket 기술을 적용해줄 수 있었고 구현하기에도 훨씬 편했다.</h5><p>socket.io 를 쓰기 위해서 실시간 양방향 통신이 필요한 위의 세 부분은 node.js 로 서버를 구성하기로 했다. <br><br></p>
<h2 id="서버와-클라이언트-소켓-연결"><a href="#서버와-클라이언트-소켓-연결" class="headerlink" title="서버와 클라이언트 소켓 연결"></a>서버와 클라이언트 소켓 연결</h2><p>먼저 간단한 서버 코드를 작성하고 클라이언트에서 소켓을 연결해보기로 한다. <br></p>
<h4 id="server-js"><a href="#server-js" class="headerlink" title="server.js"></a>server.js</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//1</span><br><span class="line">var app = require(&apos;express&apos;)();</span><br><span class="line">var http = require(&apos;http&apos;).createServer(app);</span><br><span class="line">var io = require(&apos;socket.io&apos;)(http);</span><br><span class="line"></span><br><span class="line">app.get(&apos;/&apos;, function(req, res)&#123;&#125;);</span><br><span class="line"></span><br><span class="line">//2  </span><br><span class="line">io.on(&apos;connection&apos;, function(socket)&#123;</span><br><span class="line">    console.log(&apos;클라이언트 연결됨. 소켓 id는 : &apos;, socket.id);  //2-1</span><br><span class="line"></span><br><span class="line">    socket.on(&apos;disconnect&apos;, function()&#123;   //2-2</span><br><span class="line">        console.log(&apos;사용자 연결 종료 ::&apos;, socket.id);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">//3</span><br><span class="line">http.listen(3000, function()&#123;</span><br><span class="line">    console.log(&apos;연차 노드 서버 연결 시작&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="carpoollistClient-jsp"><a href="#carpoollistClient-jsp" class="headerlink" title="carpoollistClient.jsp"></a>carpoollistClient.jsp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot; pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;탑승자 | 예약 목록&lt;/title&gt;</span><br><span class="line">&lt;script src=&quot;http://localhost:3000/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;  //4</span><br><span class="line">&lt;script src=&quot;https://code.jquery.com/jquery-1.12.4.js&quot;&gt;&lt;/script&gt;      //5</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  var socket = io(&apos;http://localhost:3000/&apos;);                          //6</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h4 id="carpoollistDriver-jsp"><a href="#carpoollistDriver-jsp" class="headerlink" title="carpoollistDriver.jsp"></a>carpoollistDriver.jsp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot; pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;운전자 | 카풀 목록&lt;/title&gt;</span><br><span class="line">&lt;script src=&quot;http://localhost:3000/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;   //4</span><br><span class="line">&lt;script src=&quot;https://code.jquery.com/jquery-1.12.4.js&quot;&gt;&lt;/script&gt;       //5</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  var socket = io(&apos;http://localhost:3000/&apos;);                           //6</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>//1 : 우선 express framework 을 이용하여 app을 만들어주고 http 서버를 생성한다. 그 http 서버를 socket.io 모듈에 연결한다.<br>//2 : 소켓에 연결되었을때의 이벤트 리스너이다. 클라이언트에서 소켓을 연결하면 바로 //2-1 에 의해 서버 콘솔창에 클라이언트의 소켓 id 가 찍힌다. 클라이언트의 url이 바뀌거나 페이지가 변경되는 등 소켓 연결이 종료되면 <code>disconnect</code> 이벤트 리스너에 의해 사용자 연결 종료를 서버측에서 확인할 수 있다.<br>//3 : http 서버의 포트번호와 서버가 시작되고 난 뒤 표시할 메시지를 정의해준다. listen() 이벤트를 통해 서버가 연결된다. <br></p>
<p>//4 : socket.io CDN을 통해 라이브러리에 연결<br>//5 : 나중에 사용할 jquery 를 위해 cdn 으로 연결<br>//6 : io() 함수 통해서 소켓 연결<br></p>
<p>운전자용 클라이언트 페이지도 같은 방식으로 소켓 연결. <br></p>
<p>두 클라이언트 페이지를 로드하면 서버의 콘솔창에 다음과 같이 표시될 것이다. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">연차 노드 서버 연결 시작</span><br><span class="line">클라이언트 연결됨. 소켓 id는 : [socket.id]</span><br><span class="line">클라이언트 연결됨. 소켓 id는 : [socket.id]</span><br></pre></td></tr></table></figure>

<p>그렇다면 이제 특정 사용자들사이에서만 실시간 데이터 공유를 할 수 있도록 코드를 작성해본다.<br><br><br></p>
<h2 id="Room-이용하여-운전자에서-운행시작버튼을-누르면-탑승자와-운전자-모두-운행중-페이지로-동시에-전환"><a href="#Room-이용하여-운전자에서-운행시작버튼을-누르면-탑승자와-운전자-모두-운행중-페이지로-동시에-전환" class="headerlink" title="Room 이용하여 운전자에서 운행시작버튼을 누르면 탑승자와 운전자 모두 운행중 페이지로 동시에 전환"></a>Room 이용하여 운전자에서 운행시작버튼을 누르면 탑승자와 운전자 모두 운행중 페이지로 동시에 전환</h2><p>socket.io 를 이용해서 1대 1 실시간 데이터 공유를 하는 방법에는 크게 2가지가 있다. </p>
<ol>
<li>‘Room’이라는 공간을 만들어 특정 두 사용자들만 룸 내부에서 정보를 공유하거나</li>
<li>내가 공유하고자 하는 사람의 socket id를 특정하여 정보를 공유하거나. </li>
</ol>
<p>나는 1번의 방법을 이용해서 2명만 들어갈 수 있는 room 을 만들어 정보를 공유하도록 했다. <br><br></p>
<h4 id="server-js-1"><a href="#server-js-1" class="headerlink" title="server.js"></a>server.js</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">//1</span><br><span class="line">var app = require(&apos;express&apos;)();</span><br><span class="line">var http = require(&apos;http&apos;).createServer(app);</span><br><span class="line">var io = require(&apos;socket.io&apos;)(http);</span><br><span class="line"></span><br><span class="line">app.get(&apos;/&apos;, function(req, res)&#123;&#125;);</span><br><span class="line"></span><br><span class="line">//2 </span><br><span class="line">io.on(&apos;connection&apos;, function(socket)&#123;</span><br><span class="line">    console.log(&apos;클라이언트 연결됨. 소켓 id는 : &apos;, socket.id);  //2-1</span><br><span class="line"></span><br><span class="line">    socket.on(&apos;disconnect&apos;, function()&#123;  //2-2</span><br><span class="line">        console.log(&apos;사용자 연결 종료 ::&apos;, socket.id);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    //7 </span><br><span class="line">    //7-1</span><br><span class="line">    //운행 시작 room</span><br><span class="line">    var startroom = new Array();</span><br><span class="line">    var startRoomIdx;</span><br><span class="line"></span><br><span class="line">    //7-2</span><br><span class="line">    //운행 시작 시 start room join 처리 </span><br><span class="line">    socket.on(&apos;join start room&apos;, function(r_idx) &#123;</span><br><span class="line">        console.log(&apos;r_idx 로 운행시작 룸 조인 &apos;, r_idx);</span><br><span class="line"></span><br><span class="line">        //7-3     </span><br><span class="line">        startRoomIdx = startroom.indexOf(&apos;startroom&apos;+r_idx);</span><br><span class="line">        if(r_idx != null  &amp;&amp; startRoomIdx == -1) &#123; //만약 r_idx 번 방이 존재하지 않다면,</span><br><span class="line">            startroom.push(&apos;startroom&apos;+r_idx); //신규 방 생성 </span><br><span class="line">            console.log(&apos;신규 결제 방 생성 : &apos;+r_idx);</span><br><span class="line">            console.log(&apos;현재 결제 방 배열 : &apos;, startroom);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //7-4</span><br><span class="line">        startRoomIdx = startroom.indexOf(&apos;startroom&apos;+r_idx);</span><br><span class="line">        socket.join(startroom[startRoomIdx], function()&#123;</span><br><span class="line">            console.log(startRoomIdx+&apos;번 운행시작 룸에 조인됨&apos;);</span><br><span class="line">            io.to(startroom[startRoomIdx]).emit(&apos;startroom join result&apos;, startRoomIdx+&apos;번 운행시작방에 조인되었습니다.&apos;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    //8</span><br><span class="line">    socket.on(&apos;start journey&apos;, function(r_idx)&#123;</span><br><span class="line">        console.log(&apos;start journey 이벤트 리슨 : &apos;, r_idx);</span><br><span class="line">        io.to(startroom[startRoomIdx]).emit(&apos;go driving page&apos;, r_idx);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">//3</span><br><span class="line">http.listen(3000, function()&#123;</span><br><span class="line">    console.log(&apos;연차 노드 서버 연결 시작&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="carpoollistClient-jsp-1"><a href="#carpoollistClient-jsp-1" class="headerlink" title="carpoollistClient.jsp"></a>carpoollistClient.jsp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot; pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;탑승자 | 예약 목록&lt;/title&gt;</span><br><span class="line">&lt;script src=&quot;http://localhost:3000/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;  //4</span><br><span class="line">&lt;script src=&quot;https://code.jquery.com/jquery-1.12.4.js&quot;&gt;&lt;/script&gt;      //5     </span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;button class=&quot;btn btn-primary&quot; onclick=&quot;drivingStart(r_idx)&quot; &gt;탑승대기&lt;/button&gt;  </span><br><span class="line"></span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    var socket = io(&apos;http://localhost:3000/&apos;);                        //6</span><br><span class="line"></span><br><span class="line">    //9</span><br><span class="line">    function drivingStart (r_idx) &#123;  </span><br><span class="line">    		//소켓 연결 </span><br><span class="line">          console.log(&apos;소켓 방 생성을 위한 r_idx &apos;+r_idx);</span><br><span class="line">          socket.emit(&apos;join start room&apos;, r_idx);  //9-1</span><br><span class="line">          socket.on(&apos;startroom join result&apos;, function(msg)&#123;</span><br><span class="line">             console.log(msg);</span><br><span class="line">          &#125;);</span><br><span class="line">          </span><br><span class="line">          alert(&apos;운전자가 운행 시작 버튼을 누르면 자동으로 운행이 시작됩니다. 조금만 기다려주세요!&apos;);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      //10</span><br><span class="line">      //운행중 page 로 redirect         </span><br><span class="line">      socket.on(&apos;go driving page&apos;, function(r_idx)&#123;</span><br><span class="line">         console.log(&apos;탑승자님, 운행 중 페이지로 이동하실게요 &apos;+r_idx);</span><br><span class="line">         setTimeout(function()&#123;</span><br><span class="line">            window.location.href=&quot;http://localhost:8080/passenger/passengerDriving.jsp?r_idx=&quot;+r_idx;</span><br><span class="line">         &#125;, 3000);</span><br><span class="line">      &#125;);  </span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h4 id="carpoollistDriver-jsp-1"><a href="#carpoollistDriver-jsp-1" class="headerlink" title="carpoollistDriver.jsp"></a>carpoollistDriver.jsp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot; pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;운전자 | 카풀 목록&lt;/title&gt;</span><br><span class="line">&lt;script src=&quot;http://localhost:3000/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;          //4</span><br><span class="line">&lt;script src=&quot;https://code.jquery.com/jquery-1.12.4.js&quot;&gt;&lt;/script&gt;              //5</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;button class=&quot;btn btn-primary&quot; id=&quot;driving&quot; onclick=&quot;drivingStart(r_idx)&quot; &gt;운행시작&lt;/button&gt;  </span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    var socket = io(&apos;http://localhost:3000/&apos;);                                 //6                  </span><br><span class="line"></span><br><span class="line">    //11</span><br><span class="line">    //운행 시작          </span><br><span class="line">    function drivingStart(r_idx) &#123;</span><br><span class="line">    	//소켓 연결 </span><br><span class="line">        console.log(&apos;소켓 연결을 위한 r_idx &apos;+r_idx);        </span><br><span class="line">        socket.emit(&apos;join start room&apos;, r_idx); </span><br><span class="line">        socket.on(&apos;startroom join result&apos;, function(msg)&#123;</span><br><span class="line">           console.log(msg);</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">      if(confirm(&apos;운행을 시작하시겠습니까?&apos;)) &#123;    	  </span><br><span class="line">         socket.emit(&apos;start journey&apos;, r_idx);</span><br><span class="line">      &#125;; </span><br><span class="line">      </span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    //12</span><br><span class="line">    //운행중 page 로 redirect               </span><br><span class="line">    socket.on(&apos;go driving page&apos;, function(r_idx)&#123;</span><br><span class="line">        console.log(&apos;운전자님, 운행 중 페이지로 이동하실게요 &apos;+r_idx);</span><br><span class="line">        setTimeout(function()&#123;</span><br><span class="line">          window.location.href=&quot;http://localhost:8080/driver/driverCarpool/driverDriving.jsp?r_idx=&quot;+r_idx;</span><br><span class="line">        &#125;, 3000);</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<ol>
<li>carpoollistClient.jsp : 탑승자 페이지에서 소켓으로 연결이 되고(//6) 새로 추가된 탑승 대기 버튼을 클릭하면 onclick 이벤트가 발생하게 된다. 이 때, 매개변수로 전해지는 r_idx 는 탑승자와 운전자 단 둘만 공유하는 예약번호이다. </li>
<li>carpoollistClient.jsp : 버튼 클릭 이벤트의 결과 실행되는 drivingStart (r_idx) 함수를 보자. 이 함수의 경우, 전달받은 r_idx 로 ‘join start room’ 이벤트를 발생시키고 있다(//9-1). 이 이벤트는 <code>server.js</code>에서 미리 정의된 이벤트 리스너에 의해 콜백함수도 응답을 받게 된다. </li>
<li>carpoollistDriver.jsp : 운전자 역시 탑승자와 비슷한 과정을 거친다. </li>
<li>server.js : 서버 단에서는 소켓 연결이 되자마자 방 배열을 하나 생성하도록 한다(//7-1). join start room 이벤트 리스너에 의해 룸 생성 및 조인 과정이 진행된다. 먼저 r_idx라는 번호의 방이 존재하는지 확인하는 작업이 필요하다. 만약 r_idx번의 방이 이미 존재한다면 //7-3 의 과정을 통과하고 그냥 join() 을 통해 룸에 조인시키면 되고 만약 방이 존재하지 않는다면 새롭게 해당 번호에 맞는 방을 만들어서 배열에 넣어줄 필요가 있다. 이렇게 되면 r_idx 를 공유하는 단 두명만 방에 조인되고 //7-4와 같이 방에 조인된 두 사용자만 조인된 룸에 대한 정보를 받는다. 물론 이 정보는 콘솔창에만 찍히므로 사용자들에게는 그에 맞는 알림이나 정보를 표시해준다. </li>
<li>carpoollistDriver.jsp : 운행 시작 버튼은 운전자에게만 있다. 따라서 운전자가 운행 시작 버튼을 누를때 ‘start journey’ 이벤트를 발생시켜 다음 흐름을 이어갈 수 있도록 처리한다. </li>
<li>server.js : 역시 미리 정의된 ‘start journey’ 이벤트 리스너에 의해 이벤트가 처리된다. 이 곳에서는 r_idx 번 startroom 에 조인되어있는 두 사용자에게 ‘go driving page’ 이벤트를 발생시킨다. </li>
<li>carpoollistClient.jsp &amp; carpoollistDriver.jsp : 두 사용자는 미리 정의해준 ‘go driving page’ 이벤트 리스너를 통해 이벤트에 대한 행동을 처리한다. 여기서는 setTimeout() 콜백함수로 정의된 내용에 따라 다음 페이지로 redirect 처리가 된다. 즉, 탑승자와 운전자의 화면이 동시에 다음 화면으로 redirect 된다.<br><br><br></li>
</ol>
<h2 id="탑승자가-운행-종료-버튼을-누르면-탑승자와-운전자-모두-결제-페이지로-이동"><a href="#탑승자가-운행-종료-버튼을-누르면-탑승자와-운전자-모두-결제-페이지로-이동" class="headerlink" title="탑승자가 운행 종료 버튼을 누르면 탑승자와 운전자 모두 결제 페이지로 이동"></a>탑승자가 운행 종료 버튼을 누르면 탑승자와 운전자 모두 결제 페이지로 이동</h2><p>운행종료버튼을 누르는 것 역시 비슷한 과정으로 진행된다. 탑승자와 운전자는 페이지 로드와 동시에 r_idx 로 만든 room 에 조인이 됨. </p>
<ol>
<li>탑승자에게만 있는 운행종료 버튼을 누르면 이벤트가 발생 </li>
<li>미리 서버에 정의해둔 이벤트 리스너에 의해 콜백함수로 페이지 이동 이벤트 전달 </li>
<li>탑승자와 운전자 모두 이벤트 리스너를 통해 결제 페이지로 동시에 이동하게 됨<br><br><br></li>
</ol>
<h4 id="server-js-2"><a href="#server-js-2" class="headerlink" title="server.js"></a>server.js</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">var app = require(&apos;express&apos;)();</span><br><span class="line">var http = require(&apos;http&apos;).createServer(app);</span><br><span class="line">var io = require(&apos;socket.io&apos;)(http);</span><br><span class="line"></span><br><span class="line">app.get(&apos;/&apos;, function(req, res)&#123;&#125;);</span><br><span class="line">  </span><br><span class="line">io.on(&apos;connection&apos;, function(socket)&#123;</span><br><span class="line">    console.log(&apos;클라이언트 연결됨. 소켓 id는 : &apos;, socket.id);</span><br><span class="line"></span><br><span class="line">    socket.on(&apos;disconnect&apos;, function()&#123;</span><br><span class="line">        console.log(&apos;사용자 연결 종료 ::&apos;, socket.id);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    //운행 도착 room </span><br><span class="line">    var room = new Array();</span><br><span class="line">    var roomIdx;</span><br><span class="line"></span><br><span class="line">    //운행 종료 시 room join 처리</span><br><span class="line">    socket.on(&apos;join room&apos;, function(r_idx)&#123;</span><br><span class="line">        console.log(&apos;r_idx 로 룸 조인 &apos;, r_idx);</span><br><span class="line">        </span><br><span class="line">        roomIdx = room.indexOf(&apos;room&apos;+r_idx);</span><br><span class="line">        if(r_idx != null  &amp;&amp; roomIdx == -1) &#123; //만약 r_idx 번 방이 존재하지 않다면,</span><br><span class="line">            room.push(&apos;room&apos;+r_idx); //신규 방 생성 </span><br><span class="line">            console.log(&apos;신규 방 생성 : &apos;+r_idx);</span><br><span class="line">            console.log(&apos;현재 방 배열 : &apos;, room);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        roomIdx = room.indexOf(&apos;room&apos;+r_idx);</span><br><span class="line">        socket.join(room[roomIdx], function()&#123;</span><br><span class="line">            console.log(roomIdx+&apos;번 운행 종료룸에 조인됨&apos;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    socket.on(&apos;arrive&apos;, function(r_idx)&#123;</span><br><span class="line">        console.log(&apos;arrive 이벤트 리슨&apos;);</span><br><span class="line">        io.to(room[roomIdx]).emit(&apos;redirect&apos;, r_idx);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">http.listen(3000, function()&#123;</span><br><span class="line">    console.log(&apos;연차 노드 서버 연결 시작&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="passengerDriving-jsp"><a href="#passengerDriving-jsp" class="headerlink" title="passengerDriving.jsp"></a>passengerDriving.jsp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot; pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;탑승자 | 운행중 &lt;/title&gt;</span><br><span class="line">&lt;script src=&quot;http://localhost:3000/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;  </span><br><span class="line">&lt;script src=&quot;https://code.jquery.com/jquery-1.12.4.js&quot;&gt;&lt;/script&gt;           </span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div class=&quot;container&quot;&gt;</span><br><span class="line">      &lt;div id=&quot;driving&quot;&gt;</span><br><span class="line">         &lt;h1&gt;YCAR&lt;/h1&gt;</span><br><span class="line">         &lt;img src=&quot;static/images/logo_yeoncha.png&quot; id=&quot;ycarLogo&quot;&gt;</span><br><span class="line">         &lt;h5&gt;탑승자분, 카풀 운행이 시작되었습니다.&lt;/h5&gt;</span><br><span class="line">         &lt;h5&gt;운행종료시 버튼을 눌러주세요!&lt;/h5&gt;&lt;br&gt;</span><br><span class="line">         &lt;div id=&quot;map_div&quot;&gt;&lt;/div&gt;</span><br><span class="line">         &lt;input type=&quot;hidden&quot; id=&quot;startlon&quot; value=&quot;&quot;&gt;</span><br><span class="line">        &lt;input type=&quot;hidden&quot; id=&quot;startlat&quot; value=&quot;&quot;&gt;</span><br><span class="line">        &lt;input type=&quot;hidden&quot; id=&quot;endlon&quot; value=&quot;&quot;&gt;</span><br><span class="line">        &lt;input type=&quot;hidden&quot; id=&quot;endlat&quot; value=&quot;&quot;&gt;</span><br><span class="line">        &lt;button id=&quot;arrBtn&quot; class=&quot;btn btn-primary rsbbtn&quot; href=&quot;#&quot;&gt;운행종료&lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">   &lt;/div&gt; </span><br><span class="line"></span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    var socket = io(&apos;http://localhost:3000/&apos;);                      </span><br><span class="line"></span><br><span class="line">     $(document).ready(function()&#123;</span><br><span class="line">     	  var socket = io(&apos;http://localhost:3000/&apos;);</span><br><span class="line"></span><br><span class="line">    	  var r_idx = document.location.search.substring(&apos;1&apos;).split(&apos;=&apos;)[1];</span><br><span class="line">         console.log(&apos;r_idx 확인 : &apos;, r_idx);  </span><br><span class="line"></span><br><span class="line">         socket.emit(&apos;join room&apos;, r_idx); </span><br><span class="line"></span><br><span class="line">         $(&apos;#arrBtn&apos;).on(&apos;click&apos;, function()&#123;</span><br><span class="line">            socket.emit(&apos;arrive&apos;, r_idx);</span><br><span class="line">            console.log(&apos;arrive 이벤트 발생&apos;);</span><br><span class="line">         &#125;)</span><br><span class="line">   </span><br><span class="line">         socket.on(&apos;redirect&apos;, function(r_idx)&#123;</span><br><span class="line">            console.log(&apos;redirect 리슨 &apos;, r_idx);</span><br><span class="line">            setTimeout(function()&#123;</span><br><span class="line">               window.location.href=&quot;http://localhost:8080/passenger/payindex.jsp?r_idx=&quot;+r_idx;</span><br><span class="line">            &#125;, 2000);</span><br><span class="line">         &#125;); </span><br><span class="line">      &#125;);  </span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h4 id="driverDriving-jsp"><a href="#driverDriving-jsp" class="headerlink" title="driverDriving.jsp"></a>driverDriving.jsp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot; pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;운전자 | 운행중&lt;/title&gt;</span><br><span class="line">&lt;script src=&quot;http://localhost:3000/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;         </span><br><span class="line">&lt;script src=&quot;https://code.jquery.com/jquery-1.12.4.js&quot;&gt;&lt;/script&gt;             </span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div class=&quot;container&quot;&gt;</span><br><span class="line">      &lt;div id=&quot;driving&quot;&gt;</span><br><span class="line">          &lt;h1&gt;YCAR&lt;/h1&gt;</span><br><span class="line">          &lt;img src=&quot;&lt;c:url value=&apos;/staticD/images/logo_yeoncha.png&apos;/&gt;&quot; id=&quot;ycarLogo&quot;&gt;</span><br><span class="line">          &lt;h5&gt;운전자분, 카풀 운행이 시작되었습니다.&lt;/h5&gt;</span><br><span class="line">          &lt;h5&gt;탑승자분이 버튼을 누르면 운행이 종료됩니다!&lt;/h5&gt;&lt;br&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div id=&quot;map_div&quot;&gt;&lt;/div&gt;</span><br><span class="line">      &lt;input type=&quot;hidden&quot; id=&quot;startlon&quot; value=&quot;&quot;&gt;</span><br><span class="line">      &lt;input type=&quot;hidden&quot; id=&quot;startlat&quot; value=&quot;&quot;&gt;</span><br><span class="line">      &lt;input type=&quot;hidden&quot; id=&quot;endlon&quot; value=&quot;&quot;&gt;</span><br><span class="line">      &lt;input type=&quot;hidden&quot; id=&quot;endlat&quot; value=&quot;&quot;&gt;</span><br><span class="line">  &lt;/div&gt; </span><br><span class="line"></span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    var socket = io(&apos;http://localhost:3000/&apos;);                                                 </span><br><span class="line"></span><br><span class="line">    $(document).ready(function() &#123;</span><br><span class="line">        </span><br><span class="line">        //이전 url 에서 r_idx 받아오기</span><br><span class="line">        var params = document.location.search.substring(&apos;1&apos;);</span><br><span class="line">        console.log(&apos;params 확인 : &apos;, params);</span><br><span class="line"></span><br><span class="line">        var parameter = params.split(&apos;=&apos;);</span><br><span class="line">        console.log(&apos;parameter 확인 : &apos;, parameter[0] + &apos; / 이글루 / &apos; + parameter[1]);</span><br><span class="line">        </span><br><span class="line">        var r_idx = parameter[1];</span><br><span class="line">        console.log(&apos;r_idx 확인 : &apos;, r_idx);</span><br><span class="line">        </span><br><span class="line">        socket.emit(&apos;join room&apos;, r_idx);</span><br><span class="line">        </span><br><span class="line">        socket.on(&apos;redirect&apos;, function(r_idx) &#123;</span><br><span class="line">            console.log(&apos;redirect 리슨 &apos;, r_idx);</span><br><span class="line">            setTimeout(function() &#123;</span><br><span class="line">                window.location.href = &quot;http://localhost:8080/driver/paymentAndReview/payment/driverPaychk.jsp?r_idx=&quot; + r_idx;</span><br><span class="line">            &#125;, 3000);</span><br><span class="line">        &#125;);      </span><br><span class="line">    &#125;);</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><br><br></p>
<h2 id="탑승자가-결제에-성공하면-탑승자와-운전자-모두-결제-내역-확인-페이지로-이동-결제-데이터의-공유"><a href="#탑승자가-결제에-성공하면-탑승자와-운전자-모두-결제-내역-확인-페이지로-이동-결제-데이터의-공유" class="headerlink" title="탑승자가 결제에 성공하면 탑승자와 운전자 모두 결제 내역 확인 페이지로 이동 : 결제 데이터의 공유"></a>탑승자가 결제에 성공하면 탑승자와 운전자 모두 결제 내역 확인 페이지로 이동 : 결제 데이터의 공유</h2><p>위의 결과 결제 페이지로 이동을 하게되면 탑승자의 결제 진행이 시작된다. 카카오, 토스, 일반카드 결제 중 탑승자는 한 가지 방법을 선택하고, 결제에 성공을 하면 탑승자와 운전자 모두 결제 내열을 확인할 수 있게 된다. </p>
<ol>
<li>탑승자의 결제 성공 </li>
<li>server.js 에서 확인 후 이벤트 리스너 콜백함수로 결제 데이터 공유 및 페이지 전환 </li>
<li>탑승자와 운전자 동시에 결제 내역 확인</li>
</ol>
<h4 id="server-js-3"><a href="#server-js-3" class="headerlink" title="server.js"></a>server.js</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">var app = require(&apos;express&apos;)();</span><br><span class="line">var http = require(&apos;http&apos;).createServer(app);</span><br><span class="line">var io = require(&apos;socket.io&apos;)(http);</span><br><span class="line"></span><br><span class="line">app.get(&apos;/&apos;, function(req, res)&#123;&#125;);</span><br><span class="line">  </span><br><span class="line">io.on(&apos;connection&apos;, function(socket)&#123;</span><br><span class="line">    console.log(&apos;클라이언트 연결됨. 소켓 id는 : &apos;, socket.id);</span><br><span class="line"></span><br><span class="line">    socket.on(&apos;disconnect&apos;, function()&#123;</span><br><span class="line">        console.log(&apos;사용자 연결 종료 ::&apos;, socket.id);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">     //결제 room </span><br><span class="line">    var payroom = new Array();</span><br><span class="line">    var payRoomIdx;</span><br><span class="line"></span><br><span class="line">    //결제 완료시 room join 처리 </span><br><span class="line">    socket.on(&apos;join payroom&apos;, function(r_idx)&#123;</span><br><span class="line">        console.log(&apos;r_idx 로 결제 룸 조인 &apos;, r_idx);</span><br><span class="line">                </span><br><span class="line">        payRoomIdx = payroom.indexOf(&apos;payroom&apos;+r_idx);</span><br><span class="line">        if(r_idx != null  &amp;&amp; payRoomIdx == -1) &#123; //만약 r_idx 번 방이 존재하지 않다면,</span><br><span class="line">            payroom.push(&apos;payroom&apos;+r_idx); //신규 방 생성 </span><br><span class="line">            console.log(&apos;신규 결제 방 생성 : &apos;+r_idx);</span><br><span class="line">            console.log(&apos;현재 결제 방 배열 : &apos;, payroom);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        payRoomIdx = payroom.indexOf(&apos;payroom&apos;+r_idx);</span><br><span class="line">        socket.join(payroom[payRoomIdx], function()&#123;</span><br><span class="line">            console.log(payRoomIdx+&apos;번 결제 룸에 조인됨&apos;);</span><br><span class="line">            io.to(payroom[payRoomIdx]).emit(&apos;payroom result&apos;, payRoomIdx+&apos;번 결제 방에 조인되었습니다.&apos;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    socket.on(&apos;send payinfo&apos;, function(</span><br><span class="line">        payidx, paydate, d_commute, d_distance, d_fee, paymethod, </span><br><span class="line">        d_starttime, d_startpoint, d_endtime, d_endpoint</span><br><span class="line">    )&#123;</span><br><span class="line">        console.log(&apos;payinfo 이벤트 리슨 &apos;, d_endpoint);</span><br><span class="line">        io.to(payroom[payRoomIdx]).emit(&apos;receive pay result&apos;, </span><br><span class="line">        payidx, paydate, d_commute, d_distance, d_fee, paymethod, </span><br><span class="line">        d_starttime, d_startpoint, d_endtime, d_endpoint);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">http.listen(3000, function()&#123;</span><br><span class="line">    console.log(&apos;연차 노드 서버 연결 시작&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="success-jsp-탑승자"><a href="#success-jsp-탑승자" class="headerlink" title="success.jsp (탑승자)"></a>success.jsp (탑승자)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot; pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;탑승자 | 결제성공&lt;/title&gt;</span><br><span class="line">&lt;script src=&quot;http://localhost:3000/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;  </span><br><span class="line">&lt;script src=&quot;https://code.jquery.com/jquery-1.12.4.js&quot;&gt;&lt;/script&gt;        </span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    var socket = io(&apos;http://localhost:3000/&apos;);  </span><br><span class="line"></span><br><span class="line">    var r_idx = paramArray0[1];</span><br><span class="line">		console.log(&apos;toss pay success 처리 시작&apos;, r_idx);</span><br><span class="line">		</span><br><span class="line">		//r_idx 방 조인 : 유니크 키인 r_idx 이용 </span><br><span class="line">		socket.emit(&apos;join payroom&apos;, r_idx);</span><br><span class="line">		</span><br><span class="line">		//listener : payroom result</span><br><span class="line">		socket.on(&apos;payroom result&apos;, function(msg)&#123;</span><br><span class="line">			console.log(msg);</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //...결제 성공 시 실행되는 매서드 중략...</span><br><span class="line"></span><br><span class="line">     //소켓서버 걸쳐 운전자 페이지로 데이터 전송</span><br><span class="line">    socket.emit(&apos;send payinfo&apos;, </span><br><span class="line">      data.payidx,</span><br><span class="line">      data.paydate,</span><br><span class="line">      data.d_commute,</span><br><span class="line">      data.d_distance,</span><br><span class="line">      data.d_fee,</span><br><span class="line">      data.paymethod,</span><br><span class="line">      data.d_starttime,</span><br><span class="line">      data.d_startpoint,</span><br><span class="line">      data.d_endtime,</span><br><span class="line">      data.d_endpoint</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    socket.on(&apos;receive pay result&apos;, function(</span><br><span class="line">    payidx, paydate, d_commute, d_distance, d_fee, paymethod, </span><br><span class="line">        d_starttime, d_startpoint, d_endtime, d_endpoint</span><br><span class="line">    )&#123;</span><br><span class="line">      console.log(&apos;운전자에게 결제 정보 전달완료&apos;, payidx);</span><br><span class="line">      //탑승자 페이지 갱신 </span><br><span class="line">      setTimeout(function()&#123;</span><br><span class="line">        //일정 시간 후 : 탑승자 후기 작성 페이지로 이동 </span><br><span class="line">        window.location.href=&apos;http://localhost:8080/passenger/review/passengerWrite.jsp?payidx=&apos;+data.payidx;</span><br><span class="line">      &#125;, 10000);</span><br><span class="line">    &#125;);</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h4 id="driverPaychk-jsp-운전자"><a href="#driverPaychk-jsp-운전자" class="headerlink" title="driverPaychk.jsp (운전자)"></a>driverPaychk.jsp (운전자)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot; pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;운전자 | 입금성공&lt;/title&gt;</span><br><span class="line">&lt;script src=&quot;http://localhost:3000/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;          </span><br><span class="line">&lt;script src=&quot;https://code.jquery.com/jquery-1.12.4.js&quot;&gt;&lt;/script&gt;              </span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    var socket = io(&apos;http://localhost:3000/&apos;);                                                 </span><br><span class="line"></span><br><span class="line">    var r_idx = document.location.search.substring(&apos;1&apos;).split(&apos;=&apos;)[1];</span><br><span class="line">    console.log(&apos;r_idx 확인 : &apos;, r_idx);  </span><br><span class="line"></span><br><span class="line">    //r_idx 방 조인 : 유니크 키인 r_idx 이용 </span><br><span class="line">    socket.emit(&apos;join payroom&apos;, r_idx);</span><br><span class="line"></span><br><span class="line">    $(document).ready(function()&#123;</span><br><span class="line"></span><br><span class="line">      //listener : payroom result</span><br><span class="line">      socket.on(&apos;payroom result&apos;, function(msg)&#123;</span><br><span class="line">        console.log(msg);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      //listener : receive info </span><br><span class="line">      socket.on(&apos;receive pay result&apos;, </span><br><span class="line">        function(payidx, paydate, d_commute, d_distance, d_fee, paymethod, </span><br><span class="line">          d_starttime, d_startpoint, d_endtime, d_endpoint)&#123; </span><br><span class="line">        console.log(&apos;driver 페이지야, 값들 들어오니?&apos;, d_startpoint);  </span><br><span class="line">        </span><br><span class="line">        var result = &apos;&apos;;</span><br><span class="line">        result += &apos;&lt;h1&gt;입금 확인&lt;/h1&gt;&lt;br&gt;&apos;;</span><br><span class="line">        result += &apos;&lt;table class=&quot;table&quot;&gt;&apos;;</span><br><span class="line">        result += &apos;&lt;thead&gt;&lt;tr&gt;&lt;th scope=&quot;col&quot;&gt;항목&lt;/th&gt;&lt;th scope=&quot;col&quot;&gt;내용&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&apos;;</span><br><span class="line">        result += &apos;&lt;tbody&gt;&apos;;</span><br><span class="line">        result += &apos;&lt;tr&gt;&lt;th scope=&quot;row&quot;&gt;날짜&lt;/th&gt;&lt;td id=&quot;d_date&quot;&gt;&apos;+paydate+&apos;&lt;/td&gt;&lt;/tr&gt;&apos;;</span><br><span class="line">        result += &apos;&lt;tr&gt;&lt;th scope=&quot;row&quot;&gt;출근/퇴근&lt;/th&gt;&lt;td id=&quot;commuteType&quot;&gt;&apos;+d_commute+&apos;&lt;/td&gt;&lt;/tr&gt;&apos;;</span><br><span class="line">        result += &apos;&lt;tr&gt;&lt;th scope=&quot;row&quot;&gt;총 운행거리&lt;/th&gt;&lt;td id=&quot;d_distance&quot;&gt;&apos;+d_distance+&apos; km&lt;/td&gt;&lt;/tr&gt;&apos;;</span><br><span class="line">        result += &apos;&lt;tr&gt;&lt;th scope=&quot;row&quot;&gt;총 금액&lt;/th&gt;&lt;td id=&quot;d_amount&quot;&gt;&apos;+d_fee+&apos;원 &lt;/td&gt;&lt;/tr&gt;&apos;;</span><br><span class="line">        result += &apos;&lt;tr&gt;&lt;th scope=&quot;row&quot;&gt;결제수단&lt;/th&gt;&lt;td id=&quot;d_method&quot;&gt;&apos;+paymethod+&apos;&lt;/td&gt;&lt;/tr&gt;&apos;;</span><br><span class="line">        result += &apos;&lt;tr&gt;&lt;th scope=&quot;row&quot;&gt;출발시간/출발지&lt;/th&gt;&lt;td id=&quot;d_stime&quot;&gt;&apos;+d_starttime+&apos; / &apos;+d_startpoint+&apos;&lt;/td&gt;&lt;/tr&gt;&apos;;</span><br><span class="line">        result += &apos;&lt;tr&gt;&lt;th scope=&quot;row&quot;&gt;도착시간/도착지&lt;/th&gt;&lt;td id=&quot;d_etime&quot;&gt;&apos;+d_endtime+&apos; / &apos;+d_endpoint+&apos;&lt;/td&gt;&lt;/tr&gt;&apos;;</span><br><span class="line">        result += &apos;&lt;/tbody&gt;&apos;;</span><br><span class="line">        result += &apos;&lt;/table&gt;&apos;;</span><br><span class="line">        </span><br><span class="line">        $(&apos;#pay-success-div&apos;).html(result);</span><br><span class="line"></span><br><span class="line">        //운전자 페이지 갱신 </span><br><span class="line">        setTimeout(function()&#123;</span><br><span class="line">          //일정 시간 후 : 탑승자 후기 작성 페이지로 이동 </span><br><span class="line">          window.location.href=&apos;http://localhost:8080/driver/paymentAndReview/review/driverWrite.jsp?payidx=&apos;+payidx;</span><br><span class="line">        &#125;, 10000);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><br><br></p>
<h4 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h4><ul>
<li>결국, 클라이언트와 서버단에서 각각 on(), emit() 통해서 이벤트 발생과 이벤트 리스너를 잘 정의해준다면, 데이터를 공유하는 것은 채팅방의 형태가 되었던, 페이지 동시 전환이던 크게 다르지 않다. </li>
<li>특정 사용자들끼리만 데이터가 공유될 수 있도록 room 을 이용한다.<br><br><br></li>
</ul>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://thebook.io/006982/" target="_blank" rel="noopener">Node.js 교과서</a></li>
<li><a href="https://medium.com/wasd/node-js%EC%99%80-socket-io%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%B1%84%ED%8C%85-%EA%B5%AC%ED%98%84-1-cb215954847b" target="_blank" rel="noopener">Node.js와 Socket.io를 이용한 채팅 구현 (1) ~ (3)</a></li>
</ul>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#nodejs" >
    <span class="tag-code">nodejs</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2019/10/19/architecture/architecture-01/">
        <span class="nav-arrow">← </span>
        
          REST에 대한 간단한 정리
        
      </a>
    
    
      <a class="nav-right" href="/2019/10/23/android/android-01/">
        
          안드로이드 환경설정, 주요 기능, HelloAndroid 프로그램 만들어보기
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
    <!-- 二维码 END -->
    
      <!-- Gitment START -->
      <div id="comments"></div>
      <!-- Gitment END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#구현하고자-하는-것-구현-결과-이미지-포함"><span class="toc-nav-text">구현하고자 하는 것 (구현 결과 이미지 포함)</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#1-카풀-리스트에서-탑승자는-탑승대기-운전자는-운행시작을-누른다-gt-gt-운행-중-화면으로-동시에-전환"><span class="toc-nav-text">1. 카풀 리스트에서 탑승자는 탑승대기, 운전자는 운행시작을 누른다 &gt;&gt; 운행 중 화면으로 동시에 전환</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#2-운행-중-화면에서-탑승자가-운행종료를-누르면-gt-gt-두-사용자의-화면이-동시에-결제페이지로-이동"><span class="toc-nav-text">2. 운행 중 화면에서 탑승자가 운행종료를 누르면 &gt;&gt; 두 사용자의 화면이 동시에 결제페이지로 이동</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#3-사용자가-결제에-성공하면-gt-gt-결제-내역-정보를-두-사용자에게-동시에-표시"><span class="toc-nav-text">3. 사용자가 결제에 성공하면 &gt;&gt; 결제 내역 정보를 두 사용자에게 동시에 표시</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#왜-node-어째서-socket-io"><span class="toc-nav-text">왜 node, 어째서 socket.io?</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#Html5-표준안의-일부로-나온-Web-Socket-프로토콜의-경우는-지원하는-브라우저가-한정되어있었고-브라우저마다-지원하는-버전에도-차이가-있었다"><span class="toc-nav-text">Html5 표준안의 일부로 나온 Web Socket 프로토콜의 경우는 지원하는 브라우저가 한정되어있었고 브라우저마다 지원하는 버전에도 차이가 있었다.</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#반면-socket-io-같은-경우는-표준기술이-아니라-node-js-모듈의-일부로서-Web-Socket과-관련-기술들을-하나의-API로-모아놓은-개념이었다-따라서-해당-모듈이-브라우저마다-적합한-socket-기술을-적용해줄-수-있었고-구현하기에도-훨씬-편했다"><span class="toc-nav-text">반면 socket.io 같은 경우는 표준기술이 아니라 node.js 모듈의 일부로서 Web Socket과 관련 기술들을 하나의 API로 모아놓은 개념이었다. 따라서 해당 모듈이 브라우저마다 적합한 socket 기술을 적용해줄 수 있었고 구현하기에도 훨씬 편했다.</span></a></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#서버와-클라이언트-소켓-연결"><span class="toc-nav-text">서버와 클라이언트 소켓 연결</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#server-js"><span class="toc-nav-text">server.js</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#carpoollistClient-jsp"><span class="toc-nav-text">carpoollistClient.jsp</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#carpoollistDriver-jsp"><span class="toc-nav-text">carpoollistDriver.jsp</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Room-이용하여-운전자에서-운행시작버튼을-누르면-탑승자와-운전자-모두-운행중-페이지로-동시에-전환"><span class="toc-nav-text">Room 이용하여 운전자에서 운행시작버튼을 누르면 탑승자와 운전자 모두 운행중 페이지로 동시에 전환</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#server-js-1"><span class="toc-nav-text">server.js</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#carpoollistClient-jsp-1"><span class="toc-nav-text">carpoollistClient.jsp</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#carpoollistDriver-jsp-1"><span class="toc-nav-text">carpoollistDriver.jsp</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#탑승자가-운행-종료-버튼을-누르면-탑승자와-운전자-모두-결제-페이지로-이동"><span class="toc-nav-text">탑승자가 운행 종료 버튼을 누르면 탑승자와 운전자 모두 결제 페이지로 이동</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#server-js-2"><span class="toc-nav-text">server.js</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#passengerDriving-jsp"><span class="toc-nav-text">passengerDriving.jsp</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#driverDriving-jsp"><span class="toc-nav-text">driverDriving.jsp</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#탑승자가-결제에-성공하면-탑승자와-운전자-모두-결제-내역-확인-페이지로-이동-결제-데이터의-공유"><span class="toc-nav-text">탑승자가 결제에 성공하면 탑승자와 운전자 모두 결제 내역 확인 페이지로 이동 : 결제 데이터의 공유</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#server-js-3"><span class="toc-nav-text">server.js</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#success-jsp-탑승자"><span class="toc-nav-text">success.jsp (탑승자)</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#driverPaychk-jsp-운전자"><span class="toc-nav-text">driverPaychk.jsp (운전자)</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#정리"><span class="toc-nav-text">정리</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#참고"><span class="toc-nav-text">참고</span></a></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'https://miniminis.github.io/2019/10/21/node/node-socket-ycar-example-1/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>




  <script>
    var gitmentConfig = "miniminis";
    if (gitmentConfig !== 'undefined') {
      var gitment = new Gitment({
        id: "Socket.io 이용하여 서로 다른 두 사용자간 실시간 데이터 공유",
        owner: "miniminis",
        repo: "miniminis.github.io",
        oauth: {
          client_id: "6777a600f48bea19d4c9",
          client_secret: "a873dcd4221c63013a85e792d2f3f0db2d90e245"
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "en-US"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  </script>




    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2020 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <!-- <br> -->
    Theme by <a href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->

<script src="/js/script.js"></script>
  </body>
</html>